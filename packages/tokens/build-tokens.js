const StyleDictionary = require('style-dictionary')
const fs = require('fs')
const path = require('path')

// Custom format for TypeScript
StyleDictionary.registerFormat({
  name: 'typescript/es6-declarations',
  formatter: function ({ dictionary }) {
    const tokens = dictionary.allTokens.reduce((acc, token) => {
      const path = token.path.join('.')
      acc[path] = token.value
      return acc
    }, {})

    return `// Generated by Style Dictionary - DO NOT EDIT
export const tokens = ${JSON.stringify(tokens, null, 2)} as const

export type Tokens = typeof tokens
`
  },
})

// Custom format for React Native
StyleDictionary.registerFormat({
  name: 'javascript/react-native',
  formatter: function ({ dictionary }) {
    const buildObj = (obj, tokens) => {
      tokens.forEach((token) => {
        const path = token.path
        let current = obj
        for (let i = 0; i < path.length - 1; i++) {
          if (!current[path[i]]) {
            current[path[i]] = {}
          }
          current = current[path[i]]
        }
        current[path[path.length - 1]] = token.value
      })
      return obj
    }

    const tokens = buildObj({}, dictionary.allTokens)

    return `// Generated by Style Dictionary - DO NOT EDIT
module.exports = ${JSON.stringify(tokens, null, 2)}
`
  },
})

// Build configuration
const buildConfig = {
  source: ['tokens/**/*.json'],
  platforms: {
    css: {
      transformGroup: 'css',
      buildPath: 'dist/css/',
      files: [
        {
          destination: 'variables.css',
          format: 'css/variables',
          options: {
            outputReferences: true,
          },
        },
      ],
    },
    js: {
      transformGroup: 'js',
      buildPath: 'dist/js/',
      files: [
        {
          destination: 'tokens.js',
          format: 'javascript/es6',
        },
        {
          destination: 'index.mjs',
          format: 'javascript/es6',
        },
        {
          destination: 'index.js',
          format: 'javascript/module',
        },
        {
          destination: 'tokens.d.ts',
          format: 'typescript/es6-declarations',
        },
      ],
    },
    reactNative: {
      transformGroup: 'react-native',
      buildPath: 'dist/react-native/',
      files: [
        {
          destination: 'tokens.js',
          format: 'javascript/react-native',
        },
      ],
    },
  },
}

console.log('ðŸŽ¨ Building design tokens...')

const sd = StyleDictionary.extend(buildConfig)
sd.buildAllPlatforms()

// Generate Figma tokens (optional)
const figmaTokens = {}
sd.allTokens.forEach((token) => {
  const category = token.path[0]
  if (!figmaTokens[category]) {
    figmaTokens[category] = {}
  }
  const name = token.path.join('.')
  figmaTokens[category][name] = {
    value: token.value,
    type: token.type || 'other',
  }
})

const figmaPath = path.join(__dirname, 'dist', 'figma')
if (!fs.existsSync(figmaPath)) {
  fs.mkdirSync(figmaPath, { recursive: true })
}

fs.writeFileSync(
  path.join(figmaPath, 'tokens.json'),
  JSON.stringify(figmaTokens, null, 2)
)

console.log('âœ… Tokens built successfully!')
console.log('   - CSS variables: dist/css/variables.css')
console.log('   - JS/TS tokens: dist/js/')
console.log('   - React Native: dist/react-native/tokens.js')
console.log('   - Figma export: dist/figma/tokens.json')
